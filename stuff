schedule_pipeline:
  stage: schedule
  image: kevinswiber/curl-jq
  # needs:
  #   - trigger_child_pipeline
  script:
    - |
      SCHEDULE_ID=$(curl --silent --header "PRIVATE-TOKEN: $PERSONAL_ACCESS_TOKEN" \
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/pipeline_schedules" | \
        jq -r '.[] | select(.description == "Scheduled Pipeline") | .id')
      
      if [ -z "$SCHEDULE_ID" ]; then
        curl --request POST --header "PRIVATE-TOKEN: $PERSONAL_ACCESS_TOKEN" \
          --form "description=Scheduled Pipeline" \
          --form "ref=main" \
          --form "cron=0 0 * * *" \
          --form "cron_timezone=UTC" \
          --form "variables[MY_VARIABLE]=my_value" \
          --form "variables[ANOTHER_VARIABLE]=another_value" \
          "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/pipeline_schedules"
      else
        curl --request PUT --header "PRIVATE-TOKEN: $PERSONAL_ACCESS_TOKEN" \
          --form "description=Scheduled Pipeline" \
          --form "ref=main" \
          --form "cron=0 17 1 * *" \
          --form "cron_timezone=UTC" \
          --form "variables[MY_VARIABLE]=my_value" \
          --form "variables[ANOTHER_VARIABLE]=another_value" \
          "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/pipeline_schedules/$SCHEDULE_ID"
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE != "schedule"'
