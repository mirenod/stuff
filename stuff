stages:
  - build
  - test
  - review
  - deploy

comment_job:
  stage: review
  image:
    name: xr09/alpine-bash
    entrypoint: [""]
  script:
    - |
      command=$(ls -la)
      
      COMMENT_BODY=$(cat <<EOM
      test number: 1
      
      This is a test comment.

      Result of command:
      <details><summary>Click to expand</summary>

      \`\`\`
      ${command}
      \`\`\`
      </details>
      
      EOM
      )

      # Construct the JSON payload using jq to ensure proper escaping 
      JSON_PAYLOAD=$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')

      echo "JSON_PAYLOAD: $JSON_PAYLOAD"
      echo "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"
      # Post the Comment to the Merge Request
      
      curl --request POST \
        --header "PRIVATE-TOKEN: $PERSONAL_ACCESS_TOKEN" \
        --header "Content-Type: application/json" \
        --data "$JSON_PAYLOAD" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"
      
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
